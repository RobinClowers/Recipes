<html>
  <head>
    <title>Recipies</title>
    <script src="lib/jquery-1.6.4.min.js"></script>
    <script src="lib/json2.js"></script>
    <script src="lib/jquery.twfile.js"></script>
    <style>
      ol { list-style-type: none; width: 400px; }
      li label { width: 0; float: left; }
      li input[type=text], select, textarea { margin-left: 100px; width: 100%; }
      li input[type=submit] { float: right; }
    </style>
  </head>
  <body>
    <h1>Recipies!</h1>
    <form id="recipe_form">
      <ol>
        <li>
          <label>List</label><select id="recipie-list" name="recipie-list"></select>
        </li>
        <li>
          <label for="title">Title</label>
          <input type="text" id="title" name="title"></input>
        </li>
        <li>
          <label for="description">Description</label>
          <textarea id="description" name="description"></textarea>
        </li>
        <li>
          <label for="tags">Tags</label>
          <input type="text" id="tags" name="tags"></input>
        </li>
        <li>
          <input type="submit" id="save" name="save" value="Save"></input>
        </li>
      </ol>
    </form>
    <script>
      var recipieBook = {
        init : function() {
          var filePath = document.location.href;
          filePath = $.twFile.convertUriToLocalPath(filePath);
          filePath = filePath.replace(/index.html/, '');
          this.filePath = filePath + 'data.json';
          this.load();
        },

        changeRecipie : function(id) {
          console.log(id);
          if(id == 0) {
            $('#title').val('');
            $('#description').val('');
            $('#tags').val('');
            return;
          }
          this.recipie = this.getRecipie(id);
          console.log(this.recipie);
          $('#recipie-list').val(id);
          $('#title').val(this.recipie.title);
          $('#description').val(this.recipie.description);
          $('#tags').val(this.recipie.tags.join(', '));
        },

        save : function() {
          if(this.recipie === null) { this.addNewRecipie(); }
          this.updateRecipie(this.recipie);
          var jsonData = JSON.stringify(this.recipies, null, 2);
          $.twFile.save(this.filePath, jsonData)
          var list = $('#recipie-list');
          list.find('option').remove();
          this.bindList();
          this.changeRecipie(this.recipie.id);
        },

        currentId : function() {
          var id = parseInt($('#recipie-list').val());
          return id == 0;
        },

        isNewRecipie : function() {
          var id = parseInt($('#recipie-list').val());
          return id == 0;
        },

        addNewRecipie : function() {
          this.recipie = {
            id: getNextId(),
            name: '',
            description: '',
            tags: []
          }
          this.recipies.push(this.recipie);
        },

        getRecipie : function(id) {
          for(var i = 0; i < this.recipies.length; i++) {
            var recipie = this.recipies[i];
            if(recipie.id == id) { return recipie; }
          }
        },

        updateRecipie : function(recipie) {
          recipie.title = $('#title').val(),
          recipie.description = $('#description').val(),
          recipie.tags = this.buildTags()
        },

        buildTags : function() {
          var list = $('#tags').val().split(',');
          return $.map(list, function (item, index) {
            if(item == '') { return null; }
            return item.trim();
          });
        },

        getNextId : function() {
          console.log(this.recipies);
          if(this.recipies.length == 0) {
            return 1;
          }
          return this.recipies[this.recipies.length -1].id + 1;
        },

        load : function() {
          fileContents = $.twFile.load(this.filePath)
          console.log('file contents: ' + fileContents);
          if(fileContents) {
            this.recipies = JSON.parse(fileContents);
          } else {
            this.recipies = [];
          }
          this.bindList();
        },

        bindList : function() {
          var list = $('#recipie-list');
          list.append($('<option />').val(0).text('New Recipie'));
          console.log(this.recipies);
          $.each(this.recipies, function() {
            list.append($('<option />').val(this.id).text(this.title));
          });
        }
      }

      function saveClick(e) {
        e.preventDefault();
        recipieBook.save();
      }

      $(function() {
        recipieBook.init();
        $('#save').click(saveClick);
        $('#recipie-list').change(function() { recipieBook.changeRecipie(this.value); });
      });
    </script>
  </body>
</html>
