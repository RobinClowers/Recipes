<html>
  <head>
    <title>Recipes</title>
    <script src="lib/jquery-1.6.4.min.js"></script>
    <script src="lib/json2.js"></script>
    <script src="lib/jquery.twfile.js"></script>
    <style>
      ol { list-style-type: none; width: 400px; }
      ol#selection { width: 100%; }
      ol#selection li { display: inline-block; }
      ol#selection li select { min-width: 200px; }
      ol#selection li label { display: block; }
      ol#recipe-fields li label { width: 0; float: left; }
      ol#recipe-fields li input[type=text], textarea { margin-left: 100px; width: 100%; }
      ol#recipe-fields li input[type=submit] { float: right; }
    </style>
  </head>
  <body>
    <h1>Recipes!</h1>
    <form id="recipe-form">
      <ol class="actions">
        <li>
          <button id="edit-tag-groups">Edit Tag Groups</button>
        </li>
      </ol>
      <ol id="selection">
        <li>
          <label>Tags</label><select id="tag-list" name="tag-list" size="10"></select>
        </li>
        <li>
          <label>List</label><select id="recipe-list" name="recipe-list" size="10"></select>
        </li>
      </ol>
      <ol id="recipe-fields">
        <li>
          <label for="title">Title</label>
          <input type="text" id="title" name="title"></input>
        </li>
        <li>
          <label for="description">Description</label>
          <textarea id="description" name="description"></textarea>
        </li>
        <li>
          <label for="tags">Tags</label>
          <input type="text" id="tags" name="tags"></input>
        </li>
        <li>
          <input type="submit" id="save" name="save" value="Save"></input>
        </li>
      </ol>
    </form>
    <form id="tag-group-form">
      <ol class="actions">
        <li>
          <button id="show-recipes">Show Recipes</button>
        </li>
      </ol>
      <ol id="ungrouped-tags"></ol>
      <ol id="tag-groups"></ol>
    </form>
    <script>
      var recipeBook = {
        init : function() {
          var filePath = document.location.href;
          filePath = $.twFile.convertUriToLocalPath(filePath);
          filePath = filePath.replace(/index.html/, '');
          this.filePath = filePath + 'data.json';
          this.load();
        },

        clearForm : function() {
          $('#title').val('');
          $('#description').val('');
          $('#tags').val('');
        },

        changeRecipe : function(id) {
          console.log(id);
          if(id == 0) {
            this.clearForm();
            return;
          }
          this.recipe = this.getRecipe(id);
          console.log(this.recipe);
          $('#recipe-list').val(id);
          $('#title').val(this.recipe.title);
          $('#description').val(this.recipe.description);
          $('#tags').val(this.recipe.tags.join(', '));
        },

        filterRecipes : function(tag) {
          console.log('filtering by: ' + tag);
          if(tag == '') {
            this.tagFilter = ''
          }
          this.tagFilter = tag;
          this.bindList();
        },

        save : function() {
          if(this.recipe === null) { this.addNewRecipe(); }
          this.updateRecipe(this.recipe);
          var data = {
            recipes : this.recipes,
            tagGroups : this.tagGroups
          };
          var jsonData = JSON.stringify(data, null, 2);
          $.twFile.save(this.filePath, jsonData)
          this.bindList();
          this.changeRecipe(this.recipe.id);
        },

        currentId : function() {
          var id = parseInt($('#recipe-list').val());
          return id == 0;
        },

        isNewRecipe : function() {
          var id = parseInt($('#recipe-list').val());
          return id == 0;
        },

        addNewRecipe : function() {
          this.recipe = {
            id: getNextId(),
            name: '',
            description: '',
            tags: []
          }
          this.recipes.push(this.recipe);
        },

        getRecipe : function(id) {
          for(var i = 0; i < this.recipes.length; i++) {
            var recipe = this.recipes[i];
            if(recipe.id == id) { return recipe; }
          }
        },

        updateRecipe : function(recipe) {
          recipe.title = $('#title').val(),
          recipe.description = $('#description').val(),
          recipe.tags = this.buildTags()
        },

        buildTags : function() {
          var list = $('#tags').val().split(',');
          return $.map(list, function (item, index) {
            if(item == '') { return null; }
            return item.trim();
          });
        },

        getNextId : function() {
          if(this.recipes.length == 0) {
            return 1;
          }
          return this.recipes[this.recipes.length -1].id + 1;
        },

        load : function() {
          fileContents = $.twFile.load(this.filePath)
          console.log('file contents: ' + fileContents);
          if(fileContents) {
            var data = JSON.parse(fileContents);
            this.recipes = data.recipes;
            this.tagGroups = data.tagGroups;
          } else {
            this.recipes = [];
            this.tagGroups = [];
          }
          console.log(this.recipes);
          this.buildTagIndex();
          this.bindTags();
          this.bindList();
        },

        buildTagIndex : function() {
          this.tags = [];
          var tags = this.tags;
          $.each(this.recipes, function(index, recipe) {
            $.each(recipe.tags, function(tagIndex, tag) {
              var notPresent = $.inArray(tag, tags) == -1;
              if(notPresent) { tags.push(tag); }
            });
          });
        },

        bindTags : function() {
          var list = $('#tag-list');
          list.append($('<option />').val('').text('All'));
          $.each(this.tags, function(index, tag) {
            list.append($('<option />').val(tag).text(tag));
          });
        },

        isFilterSet : function() {
          return typeof(this.tagFilter) != 'undefined' && this.tagFilter != '';
        },

        bindList : function() {
          var list = $('#recipe-list');
          this.clearForm();
          list.find('option').remove();
          list.append($('<option />').val(0).text('New Recipe'));
          var noFilter = !this.isFilterSet();
          var tagFilter = this.tagFilter;
          $.each(this.recipes, function() {
            var present = $.inArray(tagFilter, this.tags) != -1;
            if(noFilter || present) {
              list.append($('<option />').val(this.id).text(this.title));
            }
          });
        }
      }

      function editTagGroups(e) {
        e.preventDefault();
        $('#recipe-form').hide();
        $('#tag-group-form').show();
      }

      function showRecipes(e) {
        e.preventDefault();
        $('#tag-group-form').hide();
        $('#recipe-form').show();
      }

      function saveClick(e) {
        e.preventDefault();
        recipeBook.save();
      }

      $(function() {
        recipeBook.init();
        $('#edit-tag-groups').click(editTagGroups);
        $('#show-recipes').click(showRecipes);
        $('#save').click(saveClick);
        $('#recipe-list').change(function() { recipeBook.changeRecipe(this.value); });
        $('#tag-list').change(function() { recipeBook.filterRecipes(this.value); });
      });
    </script>
  </body>
</html>
