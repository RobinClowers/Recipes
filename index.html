<html>
  <head>
    <title>Recipies</title>
    <script src="lib/jquery-1.6.4.min.js"></script>
    <script src="lib/json2.js"></script>
    <script src="lib/jquery.twfile.js"></script>
    <style>
      ol { list-style-type: none; width: 400px; }
      li label { width: 0; float: left; }
      li input[type=text], select, textarea { margin-left: 100px; width: 100%; }
      li input[type=submit] { float: right; }
    </style>
  </head>
  <body>
    <h1>Recipies!</h1>
    <form id="recipe_form">
      <ol>
        <li>
          <label>List</label><select id="recipie-list" name="recipie-list"></select>
        </li>
        <li>
          <label for="title">Title</label>
          <input type="text" id="title" name="title"></input>
        </li>
        <li>
          <label for="description">Description</label>
          <textarea id="description" name="description"></textarea>
        </li>
        <li>
          <input type="submit" id="create" name="create" value="Create"></input>
          <input type="button" id="clear" name="clear" value="Clear"></input>
        </li>
      </ol>
    </form>
    <script>
      var recipieBook = {
        init : function() {
          var filePath = document.location.href;
          filePath = $.twFile.convertUriToLocalPath(filePath);
          filePath = filePath.replace(/index.html/, '');
          this.filePath = filePath + 'data.json';
          this.load();
        },

        changeRecipie : function(id) {
          console.log(id);
          $.each(this.recipies, function(index, recipie) {
            if(this.id == id) {
              $('#recipie-list').val(id);
              $('#title').val(this.title);
              $('#description').val(this.description);
            }
          });
        },

        save : function() {
          var id = this.getId();
          var recipie = { id: id, title: $('#title').val(), description: $('#description').val() };
          this.recipies.push(recipie);
          var jsonData = JSON.stringify(this.recipies, null, 2);
          $.twFile.save(this.filePath, jsonData)
          var list = $('#recipie-list');
          list.find('option').remove();
          this.bindList();
          this.changeRecipie(id);
        },

        getId : function() {
          var id = parseInt($('#recipie-list').val());
          if(id == 0) {
            var id = this.getNextId();
          }
          return id;
        },

        getNextId : function() {
          console.log(this.recipies);
          if(this.recipies.length == 0) {
            return 1;
          }
          return this.recipies[this.recipies.length -1].id + 1;
        },

        load : function() {
          fileContents = $.twFile.load(this.filePath)
          console.log('file contents: ' + fileContents);
          if(fileContents) {
            this.recipies = JSON.parse(fileContents);
          } else {
            this.recipies = [];
          }
          this.bindList();
        },

        bindList : function() {
          var list = $('#recipie-list');
          list.append($('<option />').val(0).text('New Recipie'));
          console.log(this.recipies);
          $.each(this.recipies, function() {
            list.append($('<option />').val(this.id).text(this.title));
          });
        },

        clear : function() {
          console.log(this.filePath);
          $.twFile.save(this.filePath, '[]');
        }
      }

      function saveClick(e) {
        e.preventDefault();
        recipieBook.save();
      }

      function clear(e) {
        recipieBook.clear();
      }

      $(function() {
        recipieBook.init();
        $('#create').click(saveClick);
        $('#clear').click(clear);
        $('#recipie-list').change(function() { recipieBook.changeRecipie(this.value); });
      });
    </script>
  </body>
</html>
